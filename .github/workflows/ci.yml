# TermiVoxed CI Pipeline
# Author: Santhosh T / LxusBrain Technologies
#
# This workflow runs on every push and pull request to ensure code quality.
# It includes linting, type checking, testing, and build verification.

name: CI

on:
  push:
    branches: [main, develop, 'feature/**', 'release/**']
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - '.gitignore'
      - 'LICENSE'
  pull_request:
    branches: [main, develop]
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - '.gitignore'
      - 'LICENSE'

# Cancel in-progress runs for the same branch
concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

env:
  PYTHON_VERSION: '3.11'
  NODE_VERSION: '20'
  # Disable telemetry
  NEXT_TELEMETRY_DISABLED: 1
  VITE_TELEMETRY_DISABLED: 1

jobs:
  # ============================================================================
  # Job 1: Python Linting & Type Checking
  # ============================================================================
  lint-python:
    name: Python Lint & Type Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install linting tools
        run: |
          python -m pip install --upgrade pip
          pip install black flake8 isort mypy

      - name: Check formatting with Black
        run: |
          black --check --diff --color .
        continue-on-error: true

      - name: Check import sorting with isort
        run: |
          isort --check-only --diff --color .
        continue-on-error: true

      - name: Lint with flake8
        run: |
          # Stop the build if there are Python syntax errors or undefined names
          # Exclude build_tools (contains PyInstaller spec templates with f-strings)
          flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics \
            --exclude=venv,__pycache__,.git,build,dist,node_modules,web_ui/frontend,backups,build_tools
          # Exit-zero treats all errors as warnings
          flake8 . --count --exit-zero --max-complexity=15 --max-line-length=120 --statistics \
            --exclude=venv,__pycache__,.git,build,dist,node_modules,web_ui/frontend,backups,build_tools

      - name: Type check with mypy
        run: |
          pip install types-requests types-PyYAML
          mypy --install-types --non-interactive --ignore-missing-imports \
            --exclude 'venv|tests|web_ui/frontend|backups|node_modules' \
            backend/ core/ models/ subscription/ || true

  # ============================================================================
  # Job 2: Frontend Linting & Type Checking
  # ============================================================================
  lint-frontend:
    name: Frontend Lint & Type Check
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: web_ui/frontend
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: web_ui/frontend/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: TypeScript type check
        run: npx tsc --noEmit

  # ============================================================================
  # Job 3: Python Unit Tests
  # ============================================================================
  test-python:
    name: Python Tests
    runs-on: ubuntu-latest
    needs: [lint-python]
    strategy:
      fail-fast: false
      matrix:
        python-version: ['3.10', '3.11', '3.12']
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip'

      - name: Cache Python virtual environment
        uses: actions/cache@v4
        with:
          path: .venv
          key: venv-${{ runner.os }}-py${{ matrix.python-version }}-${{ hashFiles('requirements.txt') }}
          restore-keys: |
            venv-${{ runner.os }}-py${{ matrix.python-version }}-

      - name: Install FFmpeg
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          python -m venv .venv || true
          source .venv/bin/activate
          pip install -r requirements.txt
          pip install pytest pytest-asyncio pytest-cov pytest-mock httpx

      - name: Run unit tests
        run: |
          source .venv/bin/activate
          pytest tests/ \
            -v \
            --tb=short \
            -m "not slow and not integration" \
            --cov=backend \
            --cov=core \
            --cov=models \
            --cov-report=xml \
            --cov-report=term-missing \
            --ignore=tests/test_voice_cloning_comprehensive.py \
            --ignore=tests/test_realtime_api.py
        env:
          PYTHONPATH: ${{ github.workspace }}
          TERMIVOXED_STORAGE_DIR: ${{ runner.temp }}/storage
          TERMIVOXED_TESTING: "true"

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        if: matrix.python-version == '3.11'
        with:
          files: ./coverage.xml
          flags: unittests
          name: codecov-termivoxed
          fail_ci_if_error: false
        env:
          CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}

  # ============================================================================
  # Job 4: Integration Tests (runs on main branch only)
  # ============================================================================
  test-integration:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: [test-python]
    if: github.ref == 'refs/heads/main' || github.event_name == 'pull_request'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Cache Python virtual environment
        uses: actions/cache@v4
        with:
          path: .venv
          key: venv-${{ runner.os }}-py${{ env.PYTHON_VERSION }}-${{ hashFiles('requirements.txt') }}
          restore-keys: |
            venv-${{ runner.os }}-py${{ env.PYTHON_VERSION }}-

      - name: Install FFmpeg
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          python -m venv .venv || true
          source .venv/bin/activate
          pip install -r requirements.txt
          pip install pytest pytest-asyncio pytest-cov pytest-mock httpx

      - name: Run integration tests
        run: |
          source .venv/bin/activate
          pytest tests/ \
            -v \
            --tb=short \
            -m "integration" \
            --timeout=300
        env:
          PYTHONPATH: ${{ github.workspace }}
          TERMIVOXED_STORAGE_DIR: ${{ runner.temp }}/storage
          TERMIVOXED_TESTING: "true"
        continue-on-error: true

  # ============================================================================
  # Job 5: Frontend Build
  # ============================================================================
  build-frontend:
    name: Build Frontend
    runs-on: ubuntu-latest
    needs: [lint-frontend]
    defaults:
      run:
        working-directory: web_ui/frontend
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: web_ui/frontend/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Build frontend
        run: npm run build
        env:
          VITE_API_URL: /api/v1
          VITE_WS_URL: /ws

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: frontend-dist
          path: web_ui/frontend/dist
          retention-days: 7

  # ============================================================================
  # Job 6: Docker Build Verification
  # ============================================================================
  build-docker:
    name: Docker Build
    runs-on: ubuntu-latest
    needs: [test-python, build-frontend]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image (no push)
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: false
          load: true  # Load image into local Docker daemon for testing
          tags: termivoxed:test
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            BUILD_DATE=${{ github.event.head_commit.timestamp }}
            VCS_REF=${{ github.sha }}

      - name: Test Docker image
        run: |
          docker run --rm termivoxed:test python -c "import backend; import core; import models; print('Imports OK')"

  # ============================================================================
  # Job 7: Security Scan
  # ============================================================================
  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install security tools
        run: |
          pip install pip-audit bandit

      - name: Check Python dependencies for vulnerabilities
        run: |
          pip install -r requirements.txt
          pip-audit --desc on || true
        continue-on-error: true

      - name: Run Bandit security linter
        run: |
          bandit -r backend/ core/ models/ subscription/ \
            -ll \
            --exclude '**/tests/**,**/__pycache__/**' \
            -f json -o bandit-report.json || true

      - name: Upload Bandit report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: bandit-security-report
          path: bandit-report.json
          retention-days: 30

  # ============================================================================
  # Job 8: Cloud Functions Lint
  # ============================================================================
  lint-cloud-functions:
    name: Cloud Functions Lint
    runs-on: ubuntu-latest
    # Always run on PRs; on push, check if cloud_functions directory exists
    defaults:
      run:
        working-directory: cloud_functions/functions
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check if cloud functions exist
        id: check_cf
        run: |
          if [ -d "cloud_functions/functions" ] && [ -f "cloud_functions/functions/package.json" ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi
        working-directory: ${{ github.workspace }}

      - name: Set up Node.js
        if: steps.check_cf.outputs.exists == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: cloud_functions/functions/package-lock.json

      - name: Install dependencies
        if: steps.check_cf.outputs.exists == 'true'
        run: npm ci

      - name: Lint cloud functions
        if: steps.check_cf.outputs.exists == 'true'
        run: npm run lint || true

  # ============================================================================
  # Job 9: Desktop Build Verification (Windows, macOS, Linux)
  # ============================================================================
  build-desktop:
    name: Desktop Build (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    needs: [test-python, build-frontend]
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            artifact_name: TermiVoxed-linux
            pyinstaller_args: --onedir
          - os: macos-latest
            artifact_name: TermiVoxed-macos
            pyinstaller_args: --onedir --osx-bundle-identifier com.lxusbrain.termivoxed
          - os: windows-latest
            artifact_name: TermiVoxed-windows
            pyinstaller_args: --onedir

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install FFmpeg (Ubuntu)
        if: matrix.os == 'ubuntu-latest'
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg libsdl2-dev

      - name: Install FFmpeg (macOS)
        if: matrix.os == 'macos-latest'
        run: brew install ffmpeg

      - name: Install FFmpeg (Windows)
        if: matrix.os == 'windows-latest'
        run: choco install ffmpeg -y

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pyinstaller

      - name: Download frontend artifact
        uses: actions/download-artifact@v4
        with:
          name: frontend-dist
          path: web_ui/frontend/dist

      - name: Build with PyInstaller (Unix)
        if: matrix.os != 'windows-latest'
        run: |
          pyinstaller --name TermiVoxed \
            ${{ matrix.pyinstaller_args }} \
            --add-data "web_ui/frontend/dist:web_ui/frontend/dist" \
            --add-data "backend:backend" \
            --add-data "core:core" \
            --add-data "models:models" \
            --add-data "subscription:subscription" \
            --add-data "utils:utils" \
            --hidden-import=uvicorn.logging \
            --hidden-import=uvicorn.loops \
            --hidden-import=uvicorn.loops.auto \
            --hidden-import=uvicorn.protocols \
            --hidden-import=uvicorn.protocols.http \
            --hidden-import=uvicorn.protocols.http.auto \
            --hidden-import=uvicorn.protocols.websockets \
            --hidden-import=uvicorn.protocols.websockets.auto \
            --hidden-import=uvicorn.lifespan \
            --hidden-import=uvicorn.lifespan.on \
            main.py

      - name: Build with PyInstaller (Windows)
        if: matrix.os == 'windows-latest'
        shell: pwsh
        run: |
          pyinstaller --name TermiVoxed `
            ${{ matrix.pyinstaller_args }} `
            --add-data "web_ui/frontend/dist;web_ui/frontend/dist" `
            --add-data "backend;backend" `
            --add-data "core;core" `
            --add-data "models;models" `
            --add-data "subscription;subscription" `
            --add-data "utils;utils" `
            --hidden-import=uvicorn.logging `
            --hidden-import=uvicorn.loops `
            --hidden-import=uvicorn.loops.auto `
            --hidden-import=uvicorn.protocols `
            --hidden-import=uvicorn.protocols.http `
            --hidden-import=uvicorn.protocols.http.auto `
            --hidden-import=uvicorn.protocols.websockets `
            --hidden-import=uvicorn.protocols.websockets.auto `
            --hidden-import=uvicorn.lifespan `
            --hidden-import=uvicorn.lifespan.on `
            main.py

      - name: Verify build output exists
        shell: bash
        run: |
          if [ -d "dist/TermiVoxed" ] || [ -d "dist/TermiVoxed.app" ]; then
            echo "✅ PyInstaller build successful!"
            ls -la dist/
          else
            echo "❌ PyInstaller build failed - no output directory"
            exit 1
          fi

      - name: Test executable runs (Unix)
        if: matrix.os != 'windows-latest'
        run: |
          # Just verify the executable exists and can show help
          if [ -f "dist/TermiVoxed/TermiVoxed" ]; then
            echo "Executable found at dist/TermiVoxed/TermiVoxed"
          elif [ -d "dist/TermiVoxed.app" ]; then
            echo "macOS app bundle found at dist/TermiVoxed.app"
          fi

      - name: Test executable runs (Windows)
        if: matrix.os == 'windows-latest'
        shell: pwsh
        run: |
          if (Test-Path "dist/TermiVoxed/TermiVoxed.exe") {
            Write-Host "Executable found at dist/TermiVoxed/TermiVoxed.exe"
          } else {
            Write-Host "Warning: Executable not found"
          }

  # ============================================================================
  # Job 10: Final Status Check
  # ============================================================================
  ci-success:
    name: CI Success
    runs-on: ubuntu-latest
    needs: [lint-python, lint-frontend, test-python, build-frontend, build-docker, build-desktop, security-scan]
    if: always()
    steps:
      - name: Check all jobs passed
        run: |
          if [[ "${{ needs.lint-python.result }}" == "failure" ]] || \
             [[ "${{ needs.lint-frontend.result }}" == "failure" ]] || \
             [[ "${{ needs.test-python.result }}" == "failure" ]] || \
             [[ "${{ needs.build-frontend.result }}" == "failure" ]] || \
             [[ "${{ needs.build-docker.result }}" == "failure" ]] || \
             [[ "${{ needs.build-desktop.result }}" == "failure" ]]; then
            echo "One or more required jobs failed"
            exit 1
          fi
          echo "All required CI jobs passed!"
