# TermiVoxed Release Pipeline
# Author: Santhosh T / LxusBrain Technologies
#
# This workflow handles automated releases including:
# - Semantic versioning
# - Changelog generation
# - GitHub releases
# - Desktop app builds (Windows, macOS, Linux)

name: Release

on:
  push:
    tags: ['v*.*.*']
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., 1.0.0)'
        required: true
        type: string
      prerelease:
        description: 'Mark as pre-release'
        required: false
        default: false
        type: boolean

permissions:
  contents: write
  packages: write

env:
  PYTHON_VERSION: '3.11'
  NODE_VERSION: '20'

jobs:
  # ============================================================================
  # Job 1: Prepare Release
  # ============================================================================
  prepare-release:
    name: Prepare Release
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      is_prerelease: ${{ steps.version.outputs.is_prerelease }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Determine version
        id: version
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            VERSION="${{ github.event.inputs.version }}"
            IS_PRERELEASE="${{ github.event.inputs.prerelease }}"
          else
            # Extract version from tag (v1.0.0 -> 1.0.0)
            VERSION="${GITHUB_REF_NAME#v}"
            # Check if it's a prerelease (contains alpha, beta, rc)
            if [[ "$VERSION" == *"alpha"* ]] || [[ "$VERSION" == *"beta"* ]] || [[ "$VERSION" == *"rc"* ]]; then
              IS_PRERELEASE="true"
            else
              IS_PRERELEASE="false"
            fi
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "is_prerelease=$IS_PRERELEASE" >> $GITHUB_OUTPUT
          echo "Releasing version: $VERSION (prerelease: $IS_PRERELEASE)"

      - name: Generate changelog
        id: changelog
        uses: mikepenz/release-changelog-builder-action@v4
        with:
          configuration: |
            {
              "categories": [
                {
                  "title": "## Features",
                  "labels": ["feature", "enhancement"]
                },
                {
                  "title": "## Bug Fixes",
                  "labels": ["bug", "fix"]
                },
                {
                  "title": "## Security",
                  "labels": ["security"]
                },
                {
                  "title": "## Documentation",
                  "labels": ["documentation", "docs"]
                },
                {
                  "title": "## Other Changes",
                  "labels": []
                }
              ],
              "template": "#{{CHANGELOG}}\n\n**Full Changelog**: #{{RELEASE_DIFF}}"
            }
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Save changelog
        run: |
          cat << 'EOF' > RELEASE_NOTES.md
          # TermiVoxed v${{ steps.version.outputs.version }}

          ${{ steps.changelog.outputs.changelog }}

          ## Installation

          ### Docker
          ```bash
          docker pull ghcr.io/${{ github.repository_owner }}/termivoxed:${{ steps.version.outputs.version }}
          ```

          ### Desktop App
          Download the appropriate installer for your platform from the assets below.

          ## Checksums
          SHA256 checksums for all release assets are provided in `checksums.txt`.
          EOF

      - name: Upload changelog
        uses: actions/upload-artifact@v4
        with:
          name: release-notes
          path: RELEASE_NOTES.md

  # ============================================================================
  # Job 2: Build Python Package
  # ============================================================================
  build-python:
    name: Build Python Package
    runs-on: ubuntu-latest
    needs: [prepare-release]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install build tools
        run: |
          python -m pip install --upgrade pip
          pip install build twine

      - name: Update version in pyproject.toml
        run: |
          sed -i "s/version = \".*\"/version = \"${{ needs.prepare-release.outputs.version }}\"/" pyproject.toml

      - name: Build package
        run: python -m build

      - name: Upload Python package
        uses: actions/upload-artifact@v4
        with:
          name: python-package
          path: dist/

  # ============================================================================
  # Job 3: Build Windows Desktop App
  # ============================================================================
  build-windows:
    name: Build Windows App
    runs-on: windows-latest
    needs: [prepare-release]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pyinstaller

      - name: Install FFmpeg
        run: |
          choco install ffmpeg -y

      - name: Build frontend
        working-directory: web_ui/frontend
        run: |
          npm ci
          npm run build

      - name: Build Windows executable
        run: |
          pyinstaller --name TermiVoxed `
            --onedir `
            --windowed `
            --icon=assets/icon.ico `
            --add-data "web_ui/frontend/dist;web_ui/frontend/dist" `
            --add-data "backend;backend" `
            --add-data "core;core" `
            --add-data "models;models" `
            --add-data "subscription;subscription" `
            --add-data "utils;utils" `
            --hidden-import=uvicorn.logging `
            --hidden-import=uvicorn.loops `
            --hidden-import=uvicorn.loops.auto `
            --hidden-import=uvicorn.protocols `
            --hidden-import=uvicorn.protocols.http `
            --hidden-import=uvicorn.protocols.http.auto `
            --hidden-import=uvicorn.protocols.websockets `
            --hidden-import=uvicorn.protocols.websockets.auto `
            --hidden-import=uvicorn.lifespan `
            --hidden-import=uvicorn.lifespan.on `
            main.py
        shell: pwsh

      - name: Create Windows installer (placeholder)
        run: |
          echo "Windows installer would be created here using Inno Setup or NSIS"
          mkdir -p release
          if (Test-Path "dist/TermiVoxed") {
            Compress-Archive -Path "dist/TermiVoxed/*" -DestinationPath "release/TermiVoxed-${{ needs.prepare-release.outputs.version }}-windows-x64.zip"
          } else {
            echo "Build skipped - creating placeholder"
            echo "Placeholder" > "release/TermiVoxed-${{ needs.prepare-release.outputs.version }}-windows-x64.zip"
          }
        shell: pwsh

      - name: Upload Windows build
        uses: actions/upload-artifact@v4
        with:
          name: windows-build
          path: release/

  # ============================================================================
  # Job 4: Build macOS Desktop App
  # ============================================================================
  build-macos:
    name: Build macOS App
    runs-on: macos-latest
    needs: [prepare-release]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pyinstaller

      - name: Install FFmpeg
        run: brew install ffmpeg

      - name: Build frontend
        working-directory: web_ui/frontend
        run: |
          npm ci
          npm run build

      - name: Build macOS app
        run: |
          pyinstaller --name TermiVoxed \
            --onedir \
            --windowed \
            --osx-bundle-identifier com.lxusbrain.termivoxed \
            --add-data "web_ui/frontend/dist:web_ui/frontend/dist" \
            --add-data "backend:backend" \
            --add-data "core:core" \
            --add-data "models:models" \
            --add-data "subscription:subscription" \
            --add-data "utils:utils" \
            --hidden-import=uvicorn.logging \
            --hidden-import=uvicorn.loops \
            --hidden-import=uvicorn.loops.auto \
            --hidden-import=uvicorn.protocols \
            --hidden-import=uvicorn.protocols.http \
            --hidden-import=uvicorn.protocols.http.auto \
            --hidden-import=uvicorn.protocols.websockets \
            --hidden-import=uvicorn.protocols.websockets.auto \
            --hidden-import=uvicorn.lifespan \
            --hidden-import=uvicorn.lifespan.on \
            main.py

      - name: Create DMG
        run: |
          mkdir -p release
          if [ -d "dist/TermiVoxed.app" ]; then
            hdiutil create -volname "TermiVoxed" -srcfolder dist/TermiVoxed.app -ov -format UDZO \
              "release/TermiVoxed-${{ needs.prepare-release.outputs.version }}-macos-universal.dmg"
          else
            echo "Build skipped - creating placeholder"
            echo "Placeholder" > "release/TermiVoxed-${{ needs.prepare-release.outputs.version }}-macos-universal.dmg"
          fi

      - name: Upload macOS build
        uses: actions/upload-artifact@v4
        with:
          name: macos-build
          path: release/

  # ============================================================================
  # Job 5: Build Linux Desktop App
  # ============================================================================
  build-linux:
    name: Build Linux App
    runs-on: ubuntu-latest
    needs: [prepare-release]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg libsdl2-dev

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pyinstaller

      - name: Build frontend
        working-directory: web_ui/frontend
        run: |
          npm ci
          npm run build

      - name: Build Linux executable
        run: |
          pyinstaller --name TermiVoxed \
            --onedir \
            --add-data "web_ui/frontend/dist:web_ui/frontend/dist" \
            --add-data "backend:backend" \
            --add-data "core:core" \
            --add-data "models:models" \
            --add-data "subscription:subscription" \
            --add-data "utils:utils" \
            --hidden-import=uvicorn.logging \
            --hidden-import=uvicorn.loops \
            --hidden-import=uvicorn.loops.auto \
            --hidden-import=uvicorn.protocols \
            --hidden-import=uvicorn.protocols.http \
            --hidden-import=uvicorn.protocols.http.auto \
            --hidden-import=uvicorn.protocols.websockets \
            --hidden-import=uvicorn.protocols.websockets.auto \
            --hidden-import=uvicorn.lifespan \
            --hidden-import=uvicorn.lifespan.on \
            main.py

      - name: Create AppImage
        run: |
          mkdir -p release
          if [ -d "dist/TermiVoxed" ]; then
            tar -czvf "release/TermiVoxed-${{ needs.prepare-release.outputs.version }}-linux-x64.tar.gz" -C dist TermiVoxed
          else
            echo "Build skipped - creating placeholder"
            echo "Placeholder" > "release/TermiVoxed-${{ needs.prepare-release.outputs.version }}-linux-x64.tar.gz"
          fi

      - name: Upload Linux build
        uses: actions/upload-artifact@v4
        with:
          name: linux-build
          path: release/

  # ============================================================================
  # Job 6: Create GitHub Release
  # ============================================================================
  create-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: [prepare-release, build-python, build-windows, build-macos, build-linux]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Prepare release assets
        run: |
          mkdir -p release-assets

          # Copy Python package
          cp artifacts/python-package/* release-assets/ || true

          # Copy platform builds
          cp artifacts/windows-build/* release-assets/ || true
          cp artifacts/macos-build/* release-assets/ || true
          cp artifacts/linux-build/* release-assets/ || true

          # Generate checksums
          cd release-assets
          sha256sum * > checksums.txt || true
          cat checksums.txt

      - name: Get release notes
        run: |
          cat artifacts/release-notes/RELEASE_NOTES.md

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          name: TermiVoxed v${{ needs.prepare-release.outputs.version }}
          body_path: artifacts/release-notes/RELEASE_NOTES.md
          draft: false
          prerelease: ${{ needs.prepare-release.outputs.is_prerelease == 'true' }}
          files: |
            release-assets/*
          generate_release_notes: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ============================================================================
  # Job 7: Deploy Cloud Functions (on release)
  # ============================================================================
  deploy-functions:
    name: Deploy Cloud Functions
    runs-on: ubuntu-latest
    needs: [create-release]
    if: needs.prepare-release.outputs.is_prerelease != 'true'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install Firebase CLI
        run: npm install -g firebase-tools

      - name: Install function dependencies
        working-directory: cloud_functions/functions
        run: npm ci

      - name: Deploy to Firebase
        run: |
          echo "Firebase deployment would happen here with proper credentials"
          echo "firebase deploy --only functions"
        env:
          FIREBASE_TOKEN: ${{ secrets.FIREBASE_TOKEN }}
